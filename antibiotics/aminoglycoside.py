"""
Aminoglycoside Dosing Calculator
Extended-Interval Dosing (Once-Daily)
"""

import streamlit as st


def render():
    """Aminoglycoside Dosing Calculator"""
    st.subheader("üíä Aminoglycoside - T√≠nh Li·ªÅu")
    st.caption("Gentamicin, Tobramycin, Amikacin - Extended-Interval Dosing")
    
    st.info("""
    **Extended-Interval Aminoglycoside Dosing** (Once-daily) - An to√†n v√† hi·ªáu qu·∫£ h∆°n:
    - Hi·ªáu qu·∫£ t∆∞∆°ng ƒë∆∞∆°ng ho·∫∑c t·ªët h∆°n multiple daily dosing
    - Gi·∫£m ƒë·ªôc th·∫≠n v√† ƒë·ªôc tai
    - Ti·ªán l·ª£i h∆°n cho b·ªánh nh√¢n
    """)
    
    col1, col2 = st.columns([2, 1])
    
    with col1:
        st.markdown("### üìã Th√¥ng S·ªë B·ªánh Nh√¢n")
        
        # Drug selection
        drug = st.selectbox(
            "**Ch·ªçn Aminoglycoside:**",
            ["Gentamicin", "Tobramycin", "Amikacin"],
            key="ag_drug"
        )
        
        # Patient info
        age = st.number_input(
            "Tu·ªïi (nƒÉm)",
            min_value=18,
            max_value=120,
            value=65,
            step=1,
            key="ag_age"
        )
        
        weight = st.number_input(
            "C√¢n n·∫∑ng (kg)",
            min_value=30.0,
            max_value=200.0,
            value=70.0,
            step=0.5,
            key="ag_weight"
        )
        
        height = st.number_input(
            "Chi·ªÅu cao (cm)",
            min_value=120,
            max_value=220,
            value=170,
            step=1,
            key="ag_height"
        )
        
        sex = st.radio(
            "Gi·ªõi t√≠nh",
            ["Nam", "N·ªØ"],
            horizontal=True,
            key="ag_sex"
        )
        
        # Calculate IBW
        if sex == "Nam":
            ibw = 50 + 2.3 * ((height - 152.4) / 2.54)
        else:
            ibw = 45.5 + 2.3 * ((height - 152.4) / 2.54)
        
        # Dosing weight calculation
        if weight > ibw * 1.25:  # Obese
            dosing_weight = ibw + 0.4 * (weight - ibw)
            st.info(f"**B√©o ph√¨:** IBW = {ibw:.1f} kg ‚Üí D√πng ABW = {dosing_weight:.1f} kg")
        else:
            dosing_weight = ibw
            st.caption(f"IBW = {ibw:.1f} kg (d√πng IBW ƒë·ªÉ t√≠nh li·ªÅu)")
        
        # Creatinine
        st.markdown("#### Creatinine M√°u")
        scr_unit = st.radio(
            "ƒê∆°n v·ªã:",
            ["mg/dL", "¬µmol/L"],
            horizontal=True,
            key="ag_scr_unit"
        )
        
        if scr_unit == "mg/dL":
            scr_mgdl = st.number_input(
                "Creatinine (mg/dL)",
                min_value=0.1,
                max_value=15.0,
                value=1.0,
                step=0.1,
                key="ag_scr_mgdl"
            )
        else:
            scr_umol = st.number_input(
                "Creatinine (¬µmol/L)",
                min_value=10.0,
                max_value=1500.0,
                value=88.0,
                step=5.0,
                key="ag_scr_umol"
            )
            scr_mgdl = scr_umol / 88.4
        
        # Calculate CrCl using IBW
        crcl = ((140 - age) * dosing_weight) / (72 * scr_mgdl)
        if sex == "N·ªØ":
            crcl *= 0.85
        crcl = round(crcl, 1)
        
        st.metric("CrCl (Cockcroft-Gault)", f"{crcl} mL/ph√∫t")
        
        # Indication
        indication = st.selectbox(
            "**Ch·ªâ ƒë·ªãnh s·ª≠ d·ª•ng:**",
            [
                "Nhi·ªÖm khu·∫©n Gram √¢m n·∫∑ng",
                "Vi√™m ph·ªïi b·ªánh vi·ªán",
                "Nhi·ªÖm khu·∫©n huy·∫øt",
                "Nhi·ªÖm khu·∫©n ph·ª©c t·∫°p trong ·ªï b·ª•ng",
                "Vi√™m n·ªôi t√¢m m·∫°c (ph·ªëi h·ª£p)",
                "Nhi·ªÖm khu·∫©n ti·∫øt ni·ªáu ph·ª©c t·∫°p"
            ],
            key="ag_indication"
        )
        
        if st.button(f"üßÆ T√≠nh Li·ªÅu {drug}", type="primary", key="ag_calc"):
            # Extended-interval dosing
            # Gentamicin/Tobramycin: 5-7 mg/kg
            # Amikacin: 15-20 mg/kg
            
            if crcl < 20:
                st.error("""
                ‚ö†Ô∏è **Ch·ª©c nƒÉng th·∫≠n qu√° th·∫•p (CrCl <20 mL/min)**
                
                Extended-interval dosing KH√îNG khuy·∫øn c√°o.
                - C·∫ßn ƒëi·ªÅu ch·ªânh li·ªÅu ƒë·∫∑c bi·ªát
                - Tham kh·∫£o d∆∞·ª£c sƒ© l√¢m s√†ng
                - C√¢n nh·∫Øc thay thu·ªëc kh√°c
                """)
                return
            
            # Calculate dose
            if drug in ["Gentamicin", "Tobramycin"]:
                # Standard dose: 5-7 mg/kg
                if "n·ªôi t√¢m m·∫°c" in indication:
                    mg_per_kg = 3  # Lower dose for synergy
                    dose = dosing_weight * mg_per_kg
                    st.warning("**L∆∞u √Ω:** Vi√™m n·ªôi t√¢m m·∫°c d√πng li·ªÅu th·∫•p ƒë·ªÉ ph·ªëi h·ª£p (synergy)")
                else:
                    mg_per_kg = 7 if "n·∫∑ng" in indication or "vi√™m ph·ªïi" in indication else 5
                    dose = dosing_weight * mg_per_kg
                
                # Round to nearest 10mg
                dose = round(dose / 10) * 10
                
                # Determine interval based on CrCl (Hartford Nomogram simplified)
                if crcl >= 60:
                    interval = 24
                    monitoring = "L·∫•y m·∫´u m√°u 6-14h sau li·ªÅu ƒë·∫ßu"
                elif crcl >= 40:
                    interval = 36
                    monitoring = "L·∫•y m·∫´u m√°u 6-14h sau li·ªÅu ƒë·∫ßu"
                else:
                    interval = 48
                    monitoring = "L·∫•y m·∫´u m√°u 6-14h sau li·ªÅu ƒë·∫ßu"
                
                # Target levels
                target_peak = "16-24 ¬µg/mL (n·∫øu ƒëo peak)"
                target_trough = "<1 ¬µg/mL tr∆∞·ªõc li·ªÅu ti·∫øp theo"
                
            else:  # Amikacin
                mg_per_kg = 15
                dose = dosing_weight * mg_per_kg
                dose = round(dose / 50) * 50  # Round to nearest 50mg
                
                if crcl >= 60:
                    interval = 24
                elif crcl >= 40:
                    interval = 36
                else:
                    interval = 48
                
                monitoring = "L·∫•y m·∫´u m√°u 6-14h sau li·ªÅu ƒë·∫ßu"
                target_peak = "56-64 ¬µg/mL (n·∫øu ƒëo peak)"
                target_trough = "<5 ¬µg/mL tr∆∞·ªõc li·ªÅu ti·∫øp theo"
            
            with col2:
                st.markdown("### üìä Li·ªÅu Khuy·∫øn C√°o")
                st.success(f"## {drug}")
                st.metric("Li·ªÅu", f"{dose:.0f} mg", f"{mg_per_kg} mg/kg")
                st.metric("T·∫ßn su·∫•t", f"M·ªói {interval}h")
                st.caption(f"C√¢n n·∫∑ng t√≠nh li·ªÅu: {dosing_weight:.1f} kg")
            
            st.markdown("### üí° Chi Ti·∫øt T√≠nh To√°n")
            st.write(f"- **Thu·ªëc:** {drug}")
            st.write(f"- **C√¢n n·∫∑ng (IBW/ABW):** {dosing_weight:.1f} kg")
            st.write(f"- **CrCl:** {crcl} mL/ph√∫t")
            st.write(f"- **Li·ªÅu:** {mg_per_kg} mg/kg √ó {dosing_weight:.1f} kg = **{dose:.0f} mg**")
            st.write(f"- **T·∫ßn su·∫•t:** M·ªói **{interval} gi·ªù**")
            
            st.markdown("---")
            st.markdown("### üéØ Therapeutic Drug Monitoring (TDM)")
            
            st.info(f"""
            **Th·ªùi ƒëi·ªÉm l·∫•y m·∫´u m√°u:**
            - {monitoring}
            - D√πng Hartford Nomogram ho·∫∑c t√≠nh to√°n d∆∞·ª£c ƒë·ªông h·ªçc
            
            **M·ª•c ti√™u n·ªìng ƒë·ªô (n·∫øu ƒëo):**
            - **Peak:** {target_peak}
            - **Trough:** {target_trough}
            
            **L∆∞u √Ω:** Extended-interval dosing th∆∞·ªùng KH√îNG c·∫ßn ƒëo peak/trough th∆∞·ªùng quy n·∫øu:
            - Th·ªùi gian ƒëi·ªÅu tr·ªã <7 ng√†y
            - Ch·ª©c nƒÉng th·∫≠n ·ªïn ƒë·ªãnh
            - Kh√¥ng b√©o ph√¨ qu√° m·ª©c
            """)
            
            st.markdown("### üìù H∆∞·ªõng D·∫´n Truy·ªÅn")
            
            if drug in ["Gentamicin", "Tobramycin"]:
                st.info(f"""
                **{drug} {dose:.0f} mg IV**
                
                **Pha thu·ªëc:**
                - Pha trong 50-100 mL NS ho·∫∑c D5W
                - N·ªìng ƒë·ªô t·ªëi ƒëa: 10 mg/mL
                
                **Truy·ªÅn:**
                - Th·ªùi gian truy·ªÅn: 30-60 ph√∫t
                - Truy·ªÅn qua pump
                - T·∫ßn su·∫•t: M·ªói {interval}h
                
                **L·∫ßn ƒë·∫ßu:**
                - Cho li·ªÅu ƒë·∫ßu ti√™n ngay
                - TDM sau 6-14h ƒë·ªÉ ƒëi·ªÅu ch·ªânh interval
                """)
            else:  # Amikacin
                st.info(f"""
                **Amikacin {dose:.0f} mg IV**
                
                **Pha thu·ªëc:**
                - Pha trong 100-200 mL NS ho·∫∑c D5W
                - N·ªìng ƒë·ªô: 5 mg/mL
                
                **Truy·ªÅn:**
                - Th·ªùi gian truy·ªÅn: 30-60 ph√∫t
                - Truy·ªÅn qua pump
                - T·∫ßn su·∫•t: M·ªói {interval}h
                
                **L·∫ßn ƒë·∫ßu:**
                - Cho li·ªÅu ƒë·∫ßu ti√™n ngay
                - TDM sau 6-14h ƒë·ªÉ ƒëi·ªÅu ch·ªânh interval
                """)
            
            st.markdown("### ‚ö†Ô∏è L∆∞u √ù An To√†n")
            st.warning("""
            **ƒê·ªôc t√≠nh c·ªßa Aminoglycosides:**
            
            **1. ƒê·ªôc th·∫≠n (Nephrotoxicity):**
            - Theo d√µi Creatinine h√†ng ng√†y
            - Nguy c∆° cao n·∫øu: tu·ªïi cao, suy gi·∫£m th·ªÉ t√≠ch, d√πng l√¢u >5-7 ng√†y
            - TƒÉng nguy c∆° n·∫øu ph·ªëi h·ª£p vancomycin, NSAID, contrast
            
            **2. ƒê·ªôc tai (Ototoxicity):**
            - H·ªèi v·ªÅ √π tai, ch√≥ng m·∫∑t
            - C√≥ th·ªÉ KH√îNG h·ªìi ph·ª•c
            - Nguy c∆° cao ·ªü ng∆∞·ªùi cao tu·ªïi, th·ªùi gian ƒëi·ªÅu tr·ªã d√†i
            
            **3. Ch·ªëng ch·ªâ ƒë·ªãnh:**
            - Myasthenia gravis (c√≥ th·ªÉ g√¢y suy nh∆∞·ª£c th·∫ßn kinh c∆°)
            - Thai k·ª≥ (ƒë·ªôc th·∫≠n thai nhi)
            
            **4. Theo d√µi:**
            - Creatinine, BUN h√†ng ng√†y
            - C√¢n b·∫±ng n∆∞·ªõc ƒëi·ªán gi·∫£i
            - H·ªèi tri·ªáu ch·ª©ng ƒë·ªôc tai
            - TDM n·∫øu: d√πng >5-7 ng√†y, ch·ª©c nƒÉng th·∫≠n kh√¥ng ·ªïn ƒë·ªãnh, b√©o ph√¨
            """)
            
            st.markdown("### üìä Hartford Nomogram")
            st.info("""
            **Hartford Nomogram** - ƒêi·ªÅu ch·ªânh interval d·ª±a tr√™n n·ªìng ƒë·ªô 6-14h sau li·ªÅu:
            
            **Gentamicin/Tobramycin:**
            - N·ªìng ƒë·ªô >6 ¬µg/mL ‚Üí Interval 48h
            - N·ªìng ƒë·ªô 3.5-6 ¬µg/mL ‚Üí Interval 36h
            - N·ªìng ƒë·ªô 1.5-3.5 ¬µg/mL ‚Üí Interval 24h
            - N·ªìng ƒë·ªô <1.5 ¬µg/mL ‚Üí Interval 24h
            
            **Amikacin:**
            - N·ªìng ƒë·ªô >18 ¬µg/mL ‚Üí Interval 48h
            - N·ªìng ƒë·ªô 10-18 ¬µg/mL ‚Üí Interval 36h
            - N·ªìng ƒë·ªô 4.5-10 ¬µg/mL ‚Üí Interval 24h
            - N·ªìng ƒë·ªô <4.5 ¬µg/mL ‚Üí Interval 24h
            
            **L∆∞u √Ω:** C·∫ßn tham kh·∫£o d∆∞·ª£c sƒ© l√¢m s√†ng ƒë·ªÉ t√≠nh to√°n ch√≠nh x√°c.
            """)
            
            with st.expander("üìö T√†i Li·ªáu Tham Kh·∫£o"):
                st.markdown("""
                **Extended-Interval Aminoglycoside Dosing**
                
                **Advantages:**
                - Equal or better efficacy
                - Reduced nephrotoxicity and ototoxicity
                - Convenient once-daily administration
                - Cost-effective
                
                **Dosing:**
                - **Gentamicin/Tobramycin:** 5-7 mg/kg/dose q24-48h
                - **Amikacin:** 15-20 mg/kg/dose q24-48h
                - Use IBW (or ABW if obese)
                
                **Interval adjustment:**
                - Based on CrCl (initial)
                - Based on Hartford Nomogram or PK calculation (subsequent)
                
                **Monitoring:**
                - Random level 6-14h after first dose
                - Adjust interval using nomogram
                - Daily SCr
                - Assess for ototoxicity
                
                **Contraindications to Extended-Interval:**
                - CrCl <20 mL/min
                - Pregnancy
                - Ascites
                - >20% burns
                - Endocarditis (use traditional dosing for synergy)
                
                **References:**
                - Nicolau DP et al. Clin Infect Dis. 1995;21(3):622-629.
                - Freeman CD et al. Pharmacotherapy. 1997;17(6):1138-1148.
                - Barza M et al. Ann Intern Med. 1996;124(8):717-725.
                
                **Guidelines:**
                - IDSA Guidelines for various infections
                - Sanford Guide to Antimicrobial Therapy
                
                **Link:**
                - https://www.idsociety.org/practice-guideline/
                """)
    
    st.markdown("---")
    st.caption("‚ö†Ô∏è C√¥ng c·ª• h·ªó tr·ª£ - Tham kh·∫£o d∆∞·ª£c sƒ© l√¢m s√†ng v√† Hartford Nomogram ƒë·ªÉ ƒëi·ªÅu ch·ªânh ch√≠nh x√°c")
