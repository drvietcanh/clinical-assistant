"""
ISTH DIC Score (International Society on Thrombosis and Haemostasis)
====================================================================

Scoring system for diagnosis of overt Disseminated Intravascular Coagulation (DIC)

Reference:
- Taylor FB Jr, et al. Towards definition, clinical and laboratory criteria, 
  and a scoring system for disseminated intravascular coagulation. 
  Thromb Haemost. 2001;86(5):1327-1330.
- Levi M, et al. Guidelines for the diagnosis and management of disseminated 
  intravascular coagulation. Br J Haematol. 2009;145(1):24-33.

Scoring Components:
1. Platelet count
2. D-dimer/Fibrin degradation products (FDP)
3. Prothrombin time (PT) prolongation
4. Fibrinogen level

Interpretation:
- Score ‚â•5: Compatible with overt DIC
- Score <5: Suggestive but not affirmative for DIC (repeat test in 1-2 days)

Note: This score should only be calculated in patients with an underlying disorder 
known to be associated with DIC (sepsis, trauma, malignancy, obstetric complications, etc.)
"""

import streamlit as st


def calculate_dic_score(
    platelet_count: float,
    ddimer_level: int,
    pt_prolongation: float,
    fibrinogen: float
) -> dict:
    """
    Calculate ISTH DIC Score
    
    Args:
        platelet_count: Platelet count (√ó10¬≥/ŒºL or √ó10‚Åπ/L)
        ddimer_level: D-dimer level category (0=no increase, 1=moderate, 2=strong)
        pt_prolongation: PT prolongation in seconds above ULN
        fibrinogen: Fibrinogen level (mg/dL)
    
    Returns:
        Dictionary containing score, interpretation, recommendations, and details
    """
    score = 0
    details = []
    
    # 1. Platelet count
    if platelet_count >= 100:
        plt_score = 0
        details.append(f"Ti·ªÉu c·∫ßu: {platelet_count:.0f} √ó10¬≥/ŒºL ‚Üí 0 ƒëi·ªÉm (‚â•100)")
    elif platelet_count >= 50:
        plt_score = 1
        details.append(f"Ti·ªÉu c·∫ßu: {platelet_count:.0f} √ó10¬≥/ŒºL ‚Üí 1 ƒëi·ªÉm (50-99)")
    else:
        plt_score = 2
        details.append(f"Ti·ªÉu c·∫ßu: {platelet_count:.0f} √ó10¬≥/ŒºL ‚Üí 2 ƒëi·ªÉm (<50)")
    score += plt_score
    
    # 2. D-dimer / FDP
    ddimer_labels = [
        "Kh√¥ng tƒÉng",
        "TƒÉng v·ª´a (>ULN nh∆∞ng <3-4√ó ULN)",
        "TƒÉng m·∫°nh (‚â•3-4√ó ULN)"
    ]
    if ddimer_level == 0:
        details.append(f"D-dimer/FDP: {ddimer_labels[0]} ‚Üí 0 ƒëi·ªÉm")
    elif ddimer_level == 1:
        details.append(f"D-dimer/FDP: {ddimer_labels[1]} ‚Üí 2 ƒëi·ªÉm")
    else:  # ddimer_level == 2
        details.append(f"D-dimer/FDP: {ddimer_labels[2]} ‚Üí 3 ƒëi·ªÉm")
    
    ddimer_score = [0, 2, 3][ddimer_level]
    score += ddimer_score
    
    # 3. PT prolongation
    if pt_prolongation < 3:
        pt_score = 0
        details.append(f"PT k√©o d√†i: {pt_prolongation:.1f}s ‚Üí 0 ƒëi·ªÉm (<3s)")
    elif pt_prolongation < 6:
        pt_score = 1
        details.append(f"PT k√©o d√†i: {pt_prolongation:.1f}s ‚Üí 1 ƒëi·ªÉm (3-5.9s)")
    else:
        pt_score = 2
        details.append(f"PT k√©o d√†i: {pt_prolongation:.1f}s ‚Üí 2 ƒëi·ªÉm (‚â•6s)")
    score += pt_score
    
    # 4. Fibrinogen
    if fibrinogen >= 100:
        fib_score = 0
        details.append(f"Fibrinogen: {fibrinogen:.0f} mg/dL ‚Üí 0 ƒëi·ªÉm (‚â•100)")
    else:
        fib_score = 1
        details.append(f"Fibrinogen: {fibrinogen:.0f} mg/dL ‚Üí 1 ƒëi·ªÉm (<100)")
    score += fib_score
    
    # Determine interpretation and recommendations
    if score >= 5:
        interpretation = "T∆Ø∆†NG TH√çCH V·ªöI DIC R√ï R√ÄNG (Overt DIC)"
        risk_class = "POSITIVE"
        color = "üî¥"
        recommendation = """
        **üî¥ X·ª≠ Tr√≠ Khuy·∫øn C√°o - OVERT DIC:**
        
        ### 1Ô∏è‚É£ ƒêI·ªÄU TR·ªä B·ªÜNH N·ªÄN - QUAN TR·ªåNG NH·∫§T
        
        **Kh√¥ng th·ªÉ ƒëi·ªÅu tr·ªã DIC n·∫øu kh√¥ng ƒëi·ªÅu tr·ªã nguy√™n nh√¢n g·ªëc!**
        
        - **Sepsis:** Kh√°ng sinh ph√π h·ª£p, ki·ªÉm so√°t nhi·ªÖm tr√πng, resuscitation
        - **Ch·∫•n th∆∞∆°ng:** Ki·ªÉm so√°t ch·∫£y m√°u, ph·∫´u thu·∫≠t, damage control
        - **Ung th∆∞:** H√≥a tr·ªã, ƒëi·ªÅu tr·ªã ung th∆∞ g√¢y DIC (promyelocytic leukemia)
        - **S·∫£n khoa:** L·∫•y thai/nhau, ƒëi·ªÅu tr·ªã pre-eclampsia/eclampsia
        - **ƒê·ªôc t·ªë:** G·∫Øp r·∫Øn, transfusion reaction ‚Üí ƒëi·ªÅu tr·ªã specific
        
        ### 2Ô∏è‚É£ H·ªñ TR·ª¢ ƒê√îNG M√ÅU
        
        **A. Truy·ªÅn Th√†nh Ph·∫ßn M√°u:**
        
        - **Ti·ªÉu c·∫ßu:**
          - M·ª•c ti√™u: >50,000/ŒºL (n·∫øu ch·∫£y m√°u ho·∫∑c th·ªß thu·∫≠t x√¢m l·∫•n)
          - M·ª•c ti√™u: >20,000/ŒºL (n·∫øu ·ªïn ƒë·ªãnh, kh√¥ng ch·∫£y m√°u)
          - Li·ªÅu: 1 unit ti·ªÉu c·∫ßu (th∆∞·ªùng tƒÉng ~5,000-10,000/ŒºL)
        
        - **Fresh Frozen Plasma (FFP):**
          - N·∫øu PT/aPTT k√©o d√†i + ch·∫£y m√°u ho·∫∑c c·∫ßn th·ªß thu·∫≠t
          - Li·ªÅu: 10-15 mL/kg (th∆∞·ªùng 4 units)
          - Kh√¥ng khuy·∫øn c√°o n·∫øu kh√¥ng ch·∫£y m√°u
        
        - **Cryoprecipitate:**
          - N·∫øu fibrinogen <100 mg/dL + ch·∫£y m√°u
          - Li·ªÅu: 10 units (tƒÉng fibrinogen ~70-100 mg/dL)
        
        - **Packed Red Blood Cells:**
          - Duy tr√¨ Hb >7 g/dL (ho·∫∑c >9 g/dL n·∫øu CAD, ho·∫°t ƒë·ªông ch·∫£y m√°u)
        
        **B. Kh√°ng ƒê√¥ng (Heparin):**
        
        ‚ö†Ô∏è **Controversial!** Ch·ªâ xem x√©t trong tr∆∞·ªùng h·ª£p ƒë·∫∑c bi·ªát:
        - **C√≥ th·ªÉ c√¢n nh·∫Øc:**
          * DIC ch·ªß y·∫øu huy·∫øt kh·ªëi (purpura fulminans, acral ischemia)
          * Acute promyelocytic leukemia (APL)
          * Retained dead fetus syndrome
          * Aortic aneurysm (Kasabach-Merritt)
        
        - **Li·ªÅu:** UFH 5-10 U/kg/h (KH√îNG loading dose)
        - **KH√îNG d√πng n·∫øu:** Ch·∫£y m√°u ho·∫°t ƒë·ªông, ti·ªÉu c·∫ßu <50,000
        
        **C. Thu·ªëc Kh√°c:**
        
        - **Tranexamic acid:** ‚ùå TR√ÅNH trong DIC c·∫•p (nguy c∆° huy·∫øt kh·ªëi)
        - **Antithrombin concentrate:** C√≥ th·ªÉ c√≥ l·ª£i nh∆∞ng evidence h·∫°n ch·∫ø
        - **Recombinant Factor VIIa:** Ch·ªâ trong tr∆∞·ªùng h·ª£p c·ª±c k·ª≥ ƒë·∫∑c bi·ªát
        
        ### 3Ô∏è‚É£ THEO D√ïI
        
        - **CBC, PT/INR, aPTT, fibrinogen:** M·ªói 6-12h ban ƒë·∫ßu
        - **D-dimer:** Theo d√µi xu h∆∞·ªõng
        - **T√≠nh l·∫°i DIC score:** H√†ng ng√†y
        - **ƒê√°nh gi√° ch·∫£y m√°u:** Li√™n t·ª•c (da, ni√™m m·∫°c, ch·ªó ch√≠ch, catheter)
        - **ƒê√°nh gi√° huy·∫øt kh·ªëi:** Acral cyanosis, purpura fulminans, organ failure
        
        ### 4Ô∏è‚É£ X·ª¨ TR√ç BI·∫æN CH·ª®NG
        
        - **Ch·∫£y m√°u:** Truy·ªÅn th√†nh ph·∫ßn, ƒëi·ªÅu tr·ªã t·∫°i ch·ªó
        - **Huy·∫øt kh·ªëi vi m·∫°ch:** Heparin li·ªÅu th·∫•p (n·∫øu ph√π h·ª£p)
        - **Suy c∆° quan:** H·ªó tr·ª£ gan/th·∫≠n/h√¥ h·∫•p
        """
        
        education = """
        **üí° Di·ªÖn Gi·∫£i - OVERT DIC:**
        
        - **DIC Score ‚â•5:** Ch·∫©n ƒëo√°n DIC r√µ r√†ng (v·ªõi b·ªánh n·ªÅn ph√π h·ª£p)
        - **DIC** l√† h·ªôi ch·ª©ng ƒë√¥ng m√°u n·ªôi m·∫°ch lan t·ªèa ‚Üí ti√™u th·ª• ti·ªÉu c·∫ßu/y·∫øu t·ªë ƒë√¥ng m√°u
        - **C∆° ch·∫ø:** K√≠ch ho·∫°t ƒë√¥ng m√°u ‚Üí ti·ªÉu c·∫ßu/fibrinogen c·∫°n ki·ªát ‚Üí ch·∫£y m√°u paradoxical
        - **Bi·ªÉu hi·ªán:** Ch·∫£y m√°u + huy·∫øt kh·ªëi + suy c∆° quan
        - **ƒêi·ªÅu tr·ªã then ch·ªët:** ƒêI·ªÄU TR·ªä B·ªÜNH N·ªÄN (sepsis, trauma, etc.)
        - **Truy·ªÅn m√°u:** H·ªó tr·ª£, KH√îNG "ƒëi·ªÅu tr·ªã" DIC
        """
        
    else:  # score < 5
        interpretation = "G·ª¢I √ù NH∆ØNG CH∆ØA X√ÅC ƒê·ªäNH DIC (Non-Overt DIC)"
        risk_class = "SUGGESTIVE"
        color = "üü°"
        recommendation = """
        **üü° X·ª≠ Tr√≠ Khuy·∫øn C√°o - NON-OVERT DIC:**
        
        ### 1Ô∏è‚É£ ƒê√ÅNH GI√Å L·∫†I
        
        - **T√≠nh l·∫°i DIC score sau 1-2 ng√†y**
        - C√≥ th·ªÉ ƒëang ·ªü giai ƒëo·∫°n S·ªöM c·ªßa DIC
        - Theo d√µi xu h∆∞·ªõng c√°c x√©t nghi·ªám ƒë√¥ng m√°u
        
        ### 2Ô∏è‚É£ XEM X√âT CH·∫®N ƒêO√ÅN KH√ÅC
        
        **N·∫øu DIC score th·∫•p nh∆∞ng c√≥ r·ªëi lo·∫°n ƒë√¥ng m√°u:**
        
        - **Suy gan:** PT k√©o d√†i, gi·∫£m fibrinogen, NH∆ØNG D-dimer th∆∞·ªùng kh√¥ng tƒÉng cao
        - **ITP (Immune Thrombocytopenic Purpura):** Gi·∫£m ti·ªÉu c·∫ßu ƒê∆†N THU·∫¶N, PT/aPTT b√¨nh th∆∞·ªùng
        - **TTP/HUS:** Gi·∫£m ti·ªÉu c·∫ßu, thi·∫øu m√°u tan m√°u, NH∆ØNG PT/aPTT b√¨nh th∆∞·ªùng
        - **Thi·∫øu vitamin K:** PT k√©o d√†i, fibrinogen b√¨nh th∆∞·ªùng, ti·ªÉu c·∫ßu b√¨nh th∆∞·ªùng
        - **Dilutional coagulopathy:** Sau truy·ªÅn m√°u/d·ªãch l·ªõn
        - **Heparin/Warfarin effect:** K√©o d√†i PT/aPTT
        
        ### 3Ô∏è‚É£ TI·∫æP T·ª§C ƒêI·ªÄU TR·ªä B·ªÜNH N·ªÄN
        
        - D√π DIC score <5, v·∫´n c·∫ßn ƒëi·ªÅu tr·ªã t√≠ch c·ª±c b·ªánh n·ªÅn
        - Sepsis ‚Üí kh√°ng sinh, resuscitation
        - Ch·∫•n th∆∞∆°ng ‚Üí ki·ªÉm so√°t ch·∫£y m√°u
        - Ung th∆∞ ‚Üí h√≥a tr·ªã n·∫øu ph√π h·ª£p
        
        ### 4Ô∏è‚É£ THEO D√ïI
        
        - **CBC, PT/INR, aPTT, fibrinogen, D-dimer:** M·ªói ng√†y
        - **T√°i ƒë√°nh gi√° DIC score:** Sau 24-48h
        - **Theo d√µi tri·ªáu ch·ª©ng:** Ch·∫£y m√°u, huy·∫øt kh·ªëi, suy c∆° quan
        
        ### 5Ô∏è‚É£ CHU·∫®N B·ªä X·ª¨ TR√ç
        
        - N·∫øu DIC score tƒÉng l√™n ‚â•5 ‚Üí x·ª≠ tr√≠ nh∆∞ OVERT DIC
        - S·∫µn s√†ng th√†nh ph·∫ßn m√°u n·∫øu c·∫ßn
        - Tr√°nh th·ªß thu·∫≠t x√¢m l·∫•n kh√¥ng c·∫ßn thi·∫øt
        """
        
        education = """
        **üí° Di·ªÖn Gi·∫£i - NON-OVERT DIC:**
        
        - **DIC Score <5:** G·ª£i √Ω r·ªëi lo·∫°n ƒë√¥ng m√°u nh∆∞ng ch∆∞a ƒë·ªß ti√™u chu·∫©n DIC r√µ r√†ng
        - C√≥ th·ªÉ l√†:
          * DIC giai ƒëo·∫°n S·ªöM (c·∫ßn theo d√µi)
          * R·ªëi lo·∫°n ƒë√¥ng m√°u do nguy√™n nh√¢n KH√ÅC (suy gan, ITP, TTP, etc.)
          * B·ªánh n·ªÅn ƒë√£ g√¢y r·ªëi lo·∫°n ƒë√¥ng m√°u nh∆∞ng ch∆∞a ph√°t tri·ªÉn th√†nh DIC
        
        - **Khuy·∫øn c√°o:**
          * T√≠nh l·∫°i score sau 24-48h
          * Ti·∫øp t·ª•c ƒëi·ªÅu tr·ªã b·ªánh n·ªÅn t√≠ch c·ª±c
          * Theo d√µi xu h∆∞·ªõng x√©t nghi·ªám
          * Xem x√©t ch·∫©n ƒëo√°n ph√¢n bi·ªát
        """
    
    # Additional clinical notes
    clinical_notes = """
    **üìå L∆ØU √ù QUAN TR·ªåNG:**
    
    1. **ISTH DIC Score CH·ªà √ÅP D·ª§NG** khi c√≥ b·ªánh n·ªÅn li√™n quan DIC:
       - Sepsis / Nhi·ªÖm tr√πng n·∫∑ng
       - Ch·∫•n th∆∞∆°ng n·∫∑ng / ƒêa ch·∫•n th∆∞∆°ng
       - Ung th∆∞ (ƒë·∫∑c bi·ªát APL, ung th∆∞ t·ª•y, ung th∆∞ ti·ªÅn li·ªát tuy·∫øn)
       - Bi·∫øn ch·ª©ng s·∫£n khoa (HELLP, thai ch·∫øt l∆∞u, nhau bong non, ·ªëi v√†o m·∫°ch)
       - Ph·∫£n ·ª©ng truy·ªÅn m√°u
       - B·ªánh gan n·∫∑ng
       - R·∫Øn ƒë·ªôc c·∫Øn
       - Ph·∫´u thu·∫≠t l·ªõn (tim, gan, t·ª•y)
    
    2. **KH√îNG t√≠nh DIC score n·∫øu kh√¥ng c√≥ b·ªánh n·ªÅn ph√π h·ª£p!**
    
    3. **DIC l√† ch·∫©n ƒëo√°n l√¢m s√†ng + x√©t nghi·ªám:**
       - Score ‚â•5 + b·ªánh n·ªÅn + bi·ªÉu hi·ªán l√¢m s√†ng ‚Üí DIC
       - Score ƒë∆°n thu·∫ßn KH√îNG ƒë·ªß ƒë·ªÉ ch·∫©n ƒëo√°n
    """
    
    return {
        'score': score,
        'interpretation': interpretation,
        'risk_class': risk_class,
        'recommendation': recommendation,
        'education': education,
        'details': details,
        'color': color,
        'clinical_notes': clinical_notes
    }


def render():
    """Render ISTH DIC Score calculator in Streamlit"""
    
    st.title("ü©∏ ISTH DIC Score")
    st.markdown("**Ch·∫©n ƒëo√°n r·ªëi lo·∫°n ƒë√¥ng m√°u n·ªôi m·∫°ch lan t·ªèa (Disseminated Intravascular Coagulation)**")
    
    # Important warning at the top
    st.error("""
    ‚ö†Ô∏è **ƒêI·ªÄU KI·ªÜN TI√äN QUY·∫æT:**
    
    Thang ƒëi·ªÉm n√†y **CH·ªà √ÅP D·ª§NG** khi b·ªánh nh√¢n c√≥ **B·ªÜNH N·ªÄN** li√™n quan ƒë·∫øn DIC:
    - Sepsis / Nhi·ªÖm tr√πng huy·∫øt n·∫∑ng
    - Ch·∫•n th∆∞∆°ng n·∫∑ng / Polytrauma
    - Ung th∆∞ (APL, ung th∆∞ t·ª•y, ti·ªÅn li·ªát tuy·∫øn, etc.)
    - Bi·∫øn ch·ª©ng s·∫£n khoa (HELLP, thai ch·∫øt l∆∞u, nhau bong non, ·ªëi v√†o m·∫°ch)
    - Ph·∫£n ·ª©ng truy·ªÅn m√°u c·∫•p
    - B·ªánh gan n·∫∑ng / Suy gan c·∫•p
    - R·∫Øn ƒë·ªôc c·∫Øn
    
    **KH√îNG t√≠nh DIC score n·∫øu kh√¥ng c√≥ b·ªánh n·ªÅn ph√π h·ª£p!**
    """)
    
    # Educational information
    with st.expander("‚ÑπÔ∏è Th√¥ng Tin & C√°ch S·ª≠ D·ª•ng"):
        st.markdown("""
        ### üìã Gi·ªõi Thi·ªáu
        
        **DIC (Disseminated Intravascular Coagulation)** l√† h·ªôi ch·ª©ng:
        - K√≠ch ho·∫°t ƒë√¥ng m√°u lan t·ªèa ‚Üí t·∫°o huy·∫øt kh·ªëi vi m·∫°ch
        - Ti√™u th·ª• ti·ªÉu c·∫ßu v√† y·∫øu t·ªë ƒë√¥ng m√°u
        - K√≠ch ho·∫°t fibrinolysis
        - K·∫øt qu·∫£: Ch·∫£y m√°u + huy·∫øt kh·ªëi + suy c∆° quan
        
        **ISTH DIC Score** gi√∫p:
        - Ch·∫©n ƒëo√°n DIC r√µ r√†ng (overt DIC)
        - Theo d√µi di·ªÖn ti·∫øn
        - ƒê√°nh gi√° ƒë√°p ·ª©ng ƒëi·ªÅu tr·ªã
        
        ### üìä Ti√™u Ch√≠ Ch·∫©n ƒêo√°n
        
        | X√©t Nghi·ªám | 0 ƒëi·ªÉm | 1 ƒëi·ªÉm | 2 ƒëi·ªÉm | 3 ƒëi·ªÉm |
        |------------|--------|--------|--------|--------|
        | **Ti·ªÉu c·∫ßu (√ó10¬≥/ŒºL)** | ‚â•100 | 50-99 | <50 | - |
        | **D-dimer/FDP** | Kh√¥ng tƒÉng | - | TƒÉng v·ª´a | TƒÉng m·∫°nh |
        | **PT k√©o d√†i (s)** | <3 | 3-5.9 | ‚â•6 | - |
        | **Fibrinogen (mg/dL)** | ‚â•100 | <100 | - | - |
        
        **Ph√¢n Lo·∫°i:**
        - **‚â•5 ƒëi·ªÉm:** Overt DIC (t∆∞∆°ng th√≠ch v·ªõi DIC r√µ r√†ng)
        - **<5 ƒëi·ªÉm:** Non-overt (g·ª£i √Ω, c·∫ßn theo d√µi)
        
        ### üéØ C√°ch S·ª≠ D·ª•ng
        
        1. **X√°c ƒë·ªãnh:** B·ªánh nh√¢n c√≥ b·ªánh n·ªÅn li√™n quan DIC
        2. **X√©t nghi·ªám:** CBC, PT/INR, aPTT, Fibrinogen, D-dimer
        3. **T√≠nh ƒëi·ªÉm:** Nh·∫≠p k·∫øt qu·∫£ v√†o calculator
        4. **Di·ªÖn gi·∫£i:** Score ‚â•5 + b·ªánh n·ªÅn + l√¢m s√†ng ‚Üí DIC
        5. **Theo d√µi:** T√≠nh l·∫°i score h√†ng ng√†y ƒë·ªÉ ƒë√°nh gi√° ƒë√°p ·ª©ng
        
        ### ‚ö†Ô∏è L∆∞u √ù
        
        - DIC l√† ch·∫©n ƒëo√°n **L√ÇM S√ÄNG + X√âT NGHI·ªÜM**
        - Score CH·ªà l√† m·ªôt ph·∫ßn trong ƒë√°nh gi√°
        - C·∫ßn c√≥: B·ªánh n·ªÅn + Bi·ªÉu hi·ªán l√¢m s√†ng + Score ‚â•5
        - ƒêi·ªÅu tr·ªã then ch·ªët: **ƒêI·ªÄU TR·ªä B·ªÜNH N·ªÄN**
        
        ### üìö T√†i Li·ªáu Tham Kh·∫£o
        
        - Taylor FB Jr, et al. *Thromb Haemost* 2001;86:1327-1330
        - Levi M, et al. *Br J Haematol* 2009;145:24-33
        - Wada H, et al. *J Intensive Care* 2014;2:15
        """)
    
    st.divider()
    
    # Input section
    st.subheader("üìù Nh·∫≠p K·∫øt Qu·∫£ X√©t Nghi·ªám")
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.markdown("#### ü©∫ Huy·∫øt H·ªçc")
        platelet_count = st.number_input(
            "**Ti·ªÉu c·∫ßu (√ó10¬≥/ŒºL ho·∫∑c √ó10‚Åπ/L)**",
            min_value=0.0,
            max_value=1000.0,
            value=100.0,
            step=1.0,
            help="S·ªë l∆∞·ª£ng ti·ªÉu c·∫ßu"
        )
        
        fibrinogen = st.number_input(
            "**Fibrinogen (mg/dL)**",
            min_value=0.0,
            max_value=1000.0,
            value=200.0,
            step=1.0,
            help="N·ªìng ƒë·ªô fibrinogen m√°u. ƒê·ªÉ chuy·ªÉn t·ª´ g/L: g/L √ó 100 = mg/dL"
        )
        
        st.caption("üí° Chuy·ªÉn ƒë·ªïi: g/L √ó 100 = mg/dL (v√≠ d·ª•: 2 g/L = 200 mg/dL)")
    
    with col2:
        st.markdown("#### ‚è±Ô∏è ƒê√¥ng M√°u")
        pt_prolongation = st.number_input(
            "**PT k√©o d√†i so v·ªõi gi·ªõi h·∫°n tr√™n (gi√¢y)**",
            min_value=0.0,
            max_value=60.0,
            value=0.0,
            step=0.1,
            help="S·ªë gi√¢y PT v∆∞·ª£t qu√° upper limit of normal (ULN). V√≠ d·ª•: PT = 18s, ULN = 13s ‚Üí k√©o d√†i 5s"
        )
        
        st.caption("üí° T√≠nh: PT b·ªánh nh√¢n - PT ULN c·ªßa lab")
        
        ddimer_level = st.radio(
            "**D-dimer / FDP**",
            options=[0, 1, 2],
            format_func=lambda x: [
                "Kh√¥ng tƒÉng (‚â§ULN)",
                "TƒÉng v·ª´a (>ULN ƒë·∫øn <3-4√ó ULN)",
                "TƒÉng m·∫°nh (‚â•3-4√ó ULN)"
            ][x],
            help="M·ª©c ƒë·ªô tƒÉng D-dimer ho·∫∑c FDP so v·ªõi gi·ªõi h·∫°n b√¨nh th∆∞·ªùng"
        )
    
    st.divider()
    
    # Calculate button
    if st.button("üßÆ T√≠nh To√°n ISTH DIC Score", type="primary", use_container_width=True):
        result = calculate_dic_score(
            platelet_count=platelet_count,
            ddimer_level=ddimer_level,
            pt_prolongation=pt_prolongation,
            fibrinogen=fibrinogen
        )
        
        # Display results
        st.subheader("üìä K·∫øt Qu·∫£")
        
        # Score box
        col_r1, col_r2 = st.columns([1, 2])
        
        with col_r1:
            st.metric(
                label="**ISTH DIC Score**",
                value=f"{result['score']} ƒëi·ªÉm"
            )
        
        with col_r2:
            st.markdown(f"### {result['color']} {result['interpretation']}")
        
        # Details
        with st.expander("üìã Chi Ti·∫øt T√≠nh ƒêi·ªÉm", expanded=True):
            for detail in result['details']:
                st.markdown(f"- {detail}")
        
        # Clinical notes
        st.info(result['clinical_notes'])
        
        # Recommendations
        st.markdown("---")
        st.markdown(result['recommendation'])
        
        # Education
        with st.expander("üí° Di·ªÖn Gi·∫£i K·∫øt Qu·∫£"):
            st.markdown(result['education'])
        
        # Additional context
        st.info("""
        **üî¨ X√©t Nghi·ªám B·ªï Sung N√™n L√†m:**
        
        - **Huy·∫øt H·ªçc:**
          * Peripheral blood smear (t√¨m schistocytes - RBC ph√¢n m·∫£nh)
          * Reticulocyte count (ƒë√°nh gi√° thi·∫øu m√°u tan m√°u)
        
        - **ƒê√¥ng M√°u:**
          * aPTT (th∆∞·ªùng k√©o d√†i)
          * Thrombin time (k√©o d√†i)
          * Fibrin degradation products (FDP) - n·∫øu kh√¥ng c√≥ D-dimer
        
        - **ƒê√°nh Gi√° C∆° Quan:**
          * Creatinine, BUN (suy th·∫≠n)
          * ALT, AST, bilirubin (suy gan)
          * Lactate (t∆∞·ªõi m√°u m√¥)
          * Blood gas (acidosis)
        
        **üìà Theo D√µi ƒêi·ªÅu Tr·ªã:**
        
        - T√≠nh l·∫°i DIC score h√†ng ng√†y
        - N·∫øu ƒëi·ªÅu tr·ªã hi·ªáu qu·∫£: Score gi·∫£m, ti·ªÉu c·∫ßu/fibrinogen tƒÉng
        - N·∫øu ƒëi·ªÅu tr·ªã kh√¥ng ƒë√°p ·ª©ng: Xem x√©t l·∫°i b·ªánh n·ªÅn, tƒÉng c∆∞·ªùng h·ªó tr·ª£
        """)
        
        # Save to session state
        st.session_state['dic_score_result'] = result
        
        # Warning
        st.warning("""
        ‚ö†Ô∏è **C·∫£nh B√°o Y Khoa:**
        - DIC l√† c·∫•p c·ª©u huy·∫øt h·ªçc nghi√™m tr·ªçng v·ªõi t·ª∑ l·ªá t·ª≠ vong cao
        - ƒêi·ªÅu tr·ªã then ch·ªët: **ƒêI·ªÄU TR·ªä B·ªÜNH N·ªÄN** (sepsis, trauma, cancer, etc.)
        - Truy·ªÅn m√°u CH·ªà l√† h·ªó tr·ª£, KH√îNG "ch·ªØa" DIC
        - Heparin r·∫•t controversial - ch·ªâ trong tr∆∞·ªùng h·ª£p ƒë·∫∑c bi·ªát
        - Quy·∫øt ƒë·ªãnh ƒëi·ªÅu tr·ªã cu·ªëi c√πng thu·ªôc v·ªÅ b√°c sƒ© ƒëi·ªÅu tr·ªã
        """)
    
    # Quick reference
    with st.expander("üìñ Nguy√™n Nh√¢n Th∆∞·ªùng G·∫∑p c·ªßa DIC"):
        st.markdown("""
        ### Nguy√™n Nh√¢n DIC Theo T·∫ßn Su·∫•t
        
        #### 1. ü¶† Sepsis / Nhi·ªÖm Tr√πng (Ph·ªï Bi·∫øn Nh·∫•t - 30-50%)
        - Gram √¢m (endotoxin) > Gram d∆∞∆°ng
        - Fungal sepsis
        - Viral (HIV, CMV, EBV, hemorrhagic fever viruses)
        - Parasitic (malaria)
        
        #### 2. ü§ï Ch·∫•n Th∆∞∆°ng / Ph·∫´u Thu·∫≠t (10-20%)
        - Ch·∫•n th∆∞∆°ng s·ªç n√£o n·∫∑ng
        - Polytrauma v·ªõi tissue injury l·ªõn
        - Fat embolism
        - Crush injury, burns
        - Ph·∫´u thu·∫≠t tim, gan, t·ª•y
        
        #### 3. üéóÔ∏è Ung Th∆∞ (10-20%)
        - **Huy·∫øt h·ªçc:**
          * Acute promyelocytic leukemia (APL) - cao nh·∫•t
          * AML, ALL
        - **Solid tumors:**
          * Adenocarcinoma (t·ª•y, tuy·∫øn ti·ªÅn li·ªát tuy·∫øn, ph·ªïi, d·∫° d√†y)
          * Mucin-producing tumors
        
        #### 4. ü§∞ S·∫£n Khoa (5-10%)
        - Nhau bong non (Placental abruption)
        - ·ªêi v√†o m·∫°ch (Amniotic fluid embolism)
        - Thai ch·∫øt l∆∞u >4 tu·∫ßn (Retained dead fetus)
        - HELLP syndrome
        - Pre-eclampsia/Eclampsia n·∫∑ng
        - Septic abortion
        
        #### 5. ü´Ä B·ªánh M·∫°ch M√°u
        - Kasabach-Merritt syndrome (giant hemangioma)
        - Aortic aneurysm (ƒë·∫∑c bi·ªát khi v·ª°)
        
        #### 6. üß™ ƒê·ªôc T·ªë / Mi·ªÖn D·ªãch
        - R·∫Øn ƒë·ªôc c·∫Øn (venom-induced consumptive coagulopathy)
        - Ph·∫£n ·ª©ng truy·ªÅn m√°u c·∫•p (Acute hemolytic transfusion reaction)
        - Transplant rejection
        
        #### 7. ü´ò B·ªánh Gan
        - Acute liver failure / Fulminant hepatitis
        - Cirrhosis ti·∫øn tri·ªÉn
        - Budd-Chiari syndrome
        
        #### 8. üå°Ô∏è Kh√°c
        - Heat stroke
        - Hypothermia n·∫∑ng
        - Massive transfusion (dilutional + consumptive)
        
        ### üîç Ph√¢n Bi·ªát DIC v·ªõi B·ªánh Kh√°c
        
        | ƒê·∫∑c ƒêi·ªÉm | DIC | Suy Gan | TTP/HUS | ITP |
        |----------|-----|---------|---------|-----|
        | Ti·ªÉu c·∫ßu | ‚Üì‚Üì | ‚Üì | ‚Üì‚Üì | ‚Üì‚Üì‚Üì |
        | PT | ‚Üë‚Üë | ‚Üë‚Üë | N | N |
        | aPTT | ‚Üë | ‚Üë | N | N |
        | Fibrinogen | ‚Üì‚Üì | ‚Üì | N | N |
        | D-dimer | ‚Üë‚Üë‚Üë | ‚Üë | N/‚Üë | N |
        | Schistocytes | + | - | +++ | - |
        | Factor VIII | ‚Üì | ‚Üì | N | N |
        
        N = b√¨nh th∆∞·ªùng, ‚Üë = tƒÉng, ‚Üì = gi·∫£m
        """)

