"""
Injury Severity Score (ISS)
============================

Anatomical scoring system for multiple trauma

Reference:
- Baker SP, et al. The injury severity score: a method for describing patients with
  multiple injuries and evaluating emergency care. J Trauma. 1974;14(3):187-196.
- Copes WS, et al. The Injury Severity Score revisited. J Trauma. 1988;28(1):69-77.

ISS Calculation:
- Based on Abbreviated Injury Scale (AIS)
- 6 body regions assessed
- ISS = sum of squares of 3 highest AIS scores (from different regions)
- Range: 1-75 (ISS of 75 automatically given if any region has AIS 6)

Body Regions:
1. Head/Neck
2. Face
3. Chest
4. Abdomen/Pelvic Contents
5. Extremities/Pelvic Girdle
6. External

Clinical Utility:
- Mortality prediction
- Triage decisions
- Research and quality improvement
- Part of TRISS score
"""

import streamlit as st


def calculate_iss(ais_scores: dict) -> dict:
    """
    Calculate Injury Severity Score
    
    Args:
        ais_scores: Dictionary of AIS scores for each body region
        
    Returns:
        Dictionary containing ISS, mortality estimate, and recommendations
    """
    
    # Check if any AIS is 6 (unsurvivable injury)
    if 6 in ais_scores.values():
        iss = 75
        mortality = ">90%"
        risk_class = "UNSURVIVABLE"
        color = "üî¥"
        interpretation = "UNSURVIVABLE INJURY (AIS 6 trong √≠t nh·∫•t 1 v√πng)"
    else:
        # Get the three highest scores from DIFFERENT regions
        sorted_scores = sorted(ais_scores.values(), reverse=True)
        top_three = sorted_scores[:3]
        
        # Calculate ISS as sum of squares of top 3
        iss = sum(score ** 2 for score in top_three)
        
        # Estimate mortality based on ISS
        if iss >= 50:
            mortality = ">50%"
            risk_class = "CRITICAL"
            color = "üî¥"
            interpretation = "CH·∫§Nth∆∞·ª£ng C·ª∞C N·∫∂NG"
        elif iss >= 25:
            mortality = "20-50%"
            risk_class = "SEVERE"
            color = "üü†"
            interpretation = "CH·∫§N TH∆Ø∆†NG N·∫∂NG"
        elif iss >= 16:
            mortality = "5-20%"
            risk_class = "MODERATE"
            color = "üü°"
            interpretation = "CH·∫§N TH∆Ø∆†NG TRUNG B√åNH"
        else:
            mortality = "<5%"
            risk_class = "MINOR"
            color = "üü¢"
            interpretation = "CH·∫§N TH∆Ø∆†NG NH·∫∏"
    
    # Management recommendations
    if risk_class == "UNSURVIVABLE" or risk_class == "CRITICAL":
        management = """
        **üî¥ X·ª≠ Tr√≠ - Ch·∫•n Th∆∞∆°ng Nguy K·ªãch:**
        
        1. **H·ªíI S·ª®C T√çCH C·ª∞C:**
           - Activate Trauma Team NGAY
           - ABC assessment v√† resuscitation
           - Massive Transfusion Protocol
           - Damage Control Resuscitation
        
        2. **CHUY·ªÇN VI·ªÜN:**
           - Trauma Center Level I NGAY L·∫¨P T·ª®C
           - Pre-notification
           - S·∫µn s√†ng ph·∫´u thu·∫≠t c·∫•p c·ª©u
        
        3. **PH·∫™U THU·∫¨T:**
           - Damage Control Surgery
           - Ki·ªÉm so√°t ch·∫£y m√°u
           - Ki·ªÉm so√°t nhi·ªÖm tr√πng
           - ƒê√≥ng t·∫°m th·ªùi
        
        4. **H·ªñ TR·ª¢ TO√ÄN DI·ªÜN:**
           - ICU monitoring
           - Ventilator support
           - Hemodynamic support
           - Renal support n·∫øu c·∫ßn
        
        5. **D·ª∞ PH√íNG BI·∫æN CH·ª®NG:**
           - DVT prophylaxis
           - Stress ulcer prophylaxis
           - Infection control
           - Nutrition support
        """
    elif risk_class == "SEVERE":
        management = """
        **üü† X·ª≠ Tr√≠ - Ch·∫•n Th∆∞∆°ng N·∫∑ng:**
        
        1. **ƒê√Ånh GI√Å TO√ÄN DI·ªÜN:**
           - Primary survey (ABC)
           - Secondary survey (head to toe)
           - FAST exam / CT scan
        
        2. **H·ªíI S·ª®C:**
           - IV access √ó 2
           - Fluid resuscitation
           - Blood products s·∫µn s√†ng
        
        3. **CHUY·ªÇN VI·ªÜN:**
           - Trauma Center Level I/II
           - ƒê·ªôi ng≈© chuy√™n khoa ƒë·∫ßy ƒë·ªß
        
        4. **X√âT NGHI·ªÜM:**
           - CBC, chemistry, coags
           - Type & cross
           - Imaging ƒë·∫ßy ƒë·ªß
        
        5. **THEO D√ïI S√ÅT:**
           - Vital signs q15-30min
           - Serial exams
           - Re-assessment li√™n t·ª•c
        """
    elif risk_class == "MODERATE":
        management = """
        **üü° X·ª≠ Tr√≠ - Ch·∫•n Th∆∞∆°ng Trung B√¨nh:**
        
        1. **ƒê√ÅNH GI√Å:**
           - Complete trauma assessment
           - Imaging ph√π h·ª£p
           - X√©t nghi·ªám c∆° b·∫£n
        
        2. **X·ª¨ TR√ç:**
           - ƒêi·ªÅu tr·ªã c√°c t·ªïn th∆∞∆°ng c·ª• th·ªÉ
           - Ph·∫´u thu·∫≠t n·∫øu c·∫ßn
           - Theo d√µi ch·∫∑t ch·∫Ω
        
        3. **XEM X√âT:**
           - Chuy·ªÉn trauma center n·∫øu c·∫ßn
           - T∆∞ v·∫•n chuy√™n khoa
        
        4. **D·ª∞ PH√íNG:**
           - Tetanus prophylaxis
           - Antibiotic n·∫øu c·∫ßn
           - Pain management
        """
    else:  # MINOR
        management = """
        **üü¢ X·ª≠ Tr√≠ - Ch·∫•n Th∆∞∆°ng Nh·∫π:**
        
        1. **ƒê√ÅNH GI√Å:**
           - Kh√°m l√¢m s√†ng k·ªπ
           - Imaging selective
           - X√©t nghi·ªám theo ch·ªâ ƒë·ªãnh
        
        2. **X·ª¨ TR√ç:**
           - ƒêi·ªÅu tr·ªã tri·ªáu ch·ª©ng
           - ChƒÉm s√≥c v·∫øt th∆∞∆°ng
           - Pain control
        
        3. **THEO D√ïI:**
           - T√°i kh√°m n·∫øu c·∫ßn
           - H∆∞·ªõng d·∫´n d·∫•u hi·ªáu c·∫£nh b√°o
        
        4. **RA VI·ªÜN:**
           - C√≥ th·ªÉ xu·∫•t vi·ªán n·∫øu ·ªïn ƒë·ªãnh
           - Follow-up ph√π h·ª£p
        """
    
    return {
        'iss': iss,
        'mortality': mortality,
        'risk_class': risk_class,
        'color': color,
        'interpretation': interpretation,
        'management': management,
        'ais_scores': ais_scores
    }


def render():
    """Render ISS calculator in Streamlit"""
    
    st.title("ü¶¥ Injury Severity Score (ISS)")
    st.markdown("**ƒê√°nh gi√° m·ª©c ƒë·ªô n·∫∑ng ƒëa ch·∫•n th∆∞∆°ng d·ª±a tr√™n gi·∫£i ph·∫´u**")
    
    # Educational information
    with st.expander("‚ÑπÔ∏è Th√¥ng Tin & C√°ch S·ª≠ D·ª•ng"):
        st.markdown("""
        ### üìã Gi·ªõi Thi·ªáu
        
        **Injury Severity Score (ISS)** l√†:
        - Thang ƒëi·ªÉm gi·∫£i ph·∫´u cho ƒëa ch·∫•n th∆∞∆°ng
        - D·ª±a tr√™n Abbreviated Injury Scale (AIS)
        - ƒê√°nh gi√° 6 v√πng c∆° th·ªÉ
        - D·ª± ƒëo√°n t·ª≠ vong
        
        ### üéØ 6 V√πng C∆° Th·ªÉ
        
        1. **Head/Neck** (ƒê·∫ßu/C·ªï)
        2. **Face** (M·∫∑t)
        3. **Chest** (Ng·ª±c)
        4. **Abdomen/Pelvic Contents** (B·ª•ng/N·ªôi t·∫°ng ch·∫≠u)
        5. **Extremities/Pelvic Girdle** (Chi/Khung ch·∫≠u)
        6. **External** (Ngo√†i - da, burns)
        
        ### üìä Abbreviated Injury Scale (AIS)
        
        | AIS | M√¥ T·∫£ | V√≠ D·ª• |
        |-----|-------|-------|
        | **0** | Kh√¥ng t·ªïn th∆∞∆°ng | - |
        | **1** | Minor | B·∫ßm t√≠m, v·∫øt tr·∫ßy |
        | **2** | Moderate | G√£y x∆∞∆°ng ƒë∆°n gi·∫£n |
        | **3** | Serious | G√£y x∆∞∆°ng ƒë√πi |
        | **4** | Severe | Hemopneumothorax, g√£y x∆∞∆°ng ch·∫≠u ph·ª©c t·∫°p |
        | **5** | Critical | R√°ch gan ƒë·ªô III-IV, ch·∫•n th∆∞∆°ng s·ªç n√£o n·∫∑ng |
        | **6** | Unsurvivable | T·ªïn th∆∞∆°ng kh√¥ng th·ªÉ s·ªëng s√≥t |
        
        ### üßÆ C√¥ng Th·ª©c ISS
        
        **ISS = A¬≤ + B¬≤ + C¬≤**
        
        Trong ƒë√≥ A, B, C l√† 3 ƒëi·ªÉm AIS CAO NH·∫§T t·ª´ 3 V√ôNG KH√ÅC NHAU
        
        **L∆∞u √Ω:**
        - Ch·ªâ l·∫•y ƒëi·ªÉm cao nh·∫•t t·ª´ M·ªñI v√πng
        - N·∫øu c√≥ AIS = 6 ·ªü b·∫•t k·ª≥ v√πng n√†o ‚Üí ISS = 75 t·ª± ƒë·ªông
        - ISS t·ªëi ƒëa = 75 (5¬≤ + 5¬≤ + 5¬≤)
        
        ### üìà Ph√¢n T·∫ßng Nguy C∆°
        
        | ISS | Ph√¢n Lo·∫°i | T·ª≠ Vong | X·ª≠ Tr√≠ |
        |-----|-----------|---------|--------|
        | 1-8 | Minor | <1% | Outpatient c√≥ th·ªÉ |
        | 9-15 | Moderate | <5% | Admit, theo d√µi |
        | 16-24 | Serious | 5-20% | ICU, chuy√™n khoa |
        | 25-49 | Severe | 20-50% | Trauma center, ICU |
        | 50-75 | Critical | >50% | H·ªìi s·ª©c t√≠ch c·ª±c |
        | 75 (AIS 6) | Unsurvivable | >90% | Palliative care |
        
        ### üìö T√†i Li·ªáu Tham Kh·∫£o
        
        - Baker SP, et al. *J Trauma* 1974;14:187-196
        - Copes WS, et al. *J Trauma* 1988;28:69-77
        """)
    
    st.divider()
    
    # Input section
    st.subheader("üìù Nh·∫≠p AIS Score Cho T·ª´ng V√πng")
    
    st.info("""
    **H∆∞·ªõng d·∫´n:** Ch·ªçn ƒëi·ªÉm AIS (0-6) cho M·ªñI v√πng c∆° th·ªÉ d·ª±a tr√™n t·ªïn th∆∞∆°ng n·∫∑ng nh·∫•t trong v√πng ƒë√≥.
    """)
    
    # Create two columns for input
    col1, col2 = st.columns(2)
    
    with col1:
        st.markdown("#### V√πng 1-3")
        
        ais_head = st.select_slider(
            "**1. Head/Neck (ƒê·∫ßu/C·ªï)**",
            options=[0, 1, 2, 3, 4, 5, 6],
            value=0,
            help="N√£o, s·ªç, c·ªôt s·ªëng c·ªï"
        )
        
        ais_face = st.select_slider(
            "**2. Face (M·∫∑t)**",
            options=[0, 1, 2, 3, 4, 5, 6],
            value=0,
            help="M·∫∑t, m·∫Øt, tai, m≈©i, mi·ªáng"
        )
        
        ais_chest = st.select_slider(
            "**3. Chest (Ng·ª±c)**",
            options=[0, 1, 2, 3, 4, 5, 6],
            value=0,
            help="L·ªìng ng·ª±c, ph·ªïi, tim, m·∫°ch m√°u l·ªõn, th·ª±c qu·∫£n"
        )
    
    with col2:
        st.markdown("#### V√πng 4-6")
        
        ais_abdomen = st.select_slider(
            "**4. Abdomen/Pelvis (B·ª•ng/Ch·∫≠u)**",
            options=[0, 1, 2, 3, 4, 5, 6],
            value=0,
            help="Gan, l√°ch, th·∫≠n, ru·ªôt, b√†ng quang, sinh d·ª•c"
        )
        
        ais_extremities = st.select_slider(
            "**5. Extremities/Pelvic Girdle (Chi/Khung ch·∫≠u)**",
            options=[0, 1, 2, 3, 4, 5, 6],
            value=0,
            help="Tay, ch√¢n, khung ch·∫≠u, x∆∞∆°ng, m·∫°ch m√°u ngo·∫°i vi"
        )
        
        ais_external = st.select_slider(
            "**6. External (B·ªÅ m·∫∑t)**",
            options=[0, 1, 2, 3, 4, 5, 6],
            value=0,
            help="Da, b·ªèng, v·∫øt th∆∞∆°ng ngo√†i"
        )
    
    st.divider()
    
    # Calculate button
    if st.button("üßÆ T√≠nh ISS & Ti√™n L∆∞·ª£ng", type="primary", use_container_width=True):
        ais_scores = {
            'Head/Neck': ais_head,
            'Face': ais_face,
            'Chest': ais_chest,
            'Abdomen/Pelvis': ais_abdomen,
            'Extremities': ais_extremities,
            'External': ais_external
        }
        
        result = calculate_iss(ais_scores)
        
        # Display results
        st.subheader("üìä K·∫øt Qu·∫£")
        
        # Score box
        col_r1, col_r2 = st.columns([1, 2])
        
        with col_r1:
            st.metric(
                label="**Injury Severity Score**",
                value=result['iss']
            )
            st.caption("1-75 (cao = n·∫∑ng h∆°n)")
        
        with col_r2:
            st.markdown(f"### {result['color']} {result['interpretation']}")
            st.markdown(f"**T·ª∑ l·ªá t·ª≠ vong ∆∞·ªõc t√≠nh: {result['mortality']}**")
        
        # Calculation details
        with st.expander("üìã Chi Ti·∫øt T√≠nh To√°n", expanded=True):
            st.markdown("**AIS Scores theo v√πng:**")
            sorted_regions = sorted(result['ais_scores'].items(), key=lambda x: x[1], reverse=True)
            
            for region, score in sorted_regions:
                if score > 0:
                    st.markdown(f"- **{region}:** AIS {score}")
            
            st.markdown("")
            
            # Show calculation
            top_three = sorted([score for score in result['ais_scores'].values()], reverse=True)[:3]
            
            if result['iss'] == 75 and 6 in result['ais_scores'].values():
                st.markdown("**T√≠nh ISS:**")
                st.markdown(f"- C√≥ t·ªïn th∆∞∆°ng AIS 6 (unsurvivable) ‚Üí ISS = 75 t·ª± ƒë·ªông")
            else:
                st.markdown("**T√≠nh ISS:**")
                st.markdown(f"- 3 ƒëi·ªÉm AIS cao nh·∫•t (t·ª´ 3 v√πng kh√°c nhau): {top_three[0]}, {top_three[1]}, {top_three[2]}")
                st.markdown(f"- ISS = {top_three[0]}¬≤ + {top_three[1]}¬≤ + {top_three[2]}¬≤")
                st.markdown(f"- ISS = {top_three[0]**2} + {top_three[1]**2} + {top_three[2]**2}")
                st.markdown(f"- **ISS = {result['iss']}**")
        
        # Management
        st.markdown("---")
        st.markdown("### üíä X·ª≠ Tr√≠ & Qu·∫£n L√Ω")
        st.markdown(result['management'])
        
        # Additional info
        st.info("""
        **üìå L∆∞u √ù Quan Tr·ªçng:**
        
        - **ISS** l√† thang ƒëi·ªÉm GI·∫¢I PH·∫™U (anatomical), ƒë√°nh gi√° t·ªïn th∆∞∆°ng c∆° th·ªÉ
        - **RTS** l√† thang ƒëi·ªÉm SINH L√ù (physiological), ƒë√°nh gi√° ch·ª©c nƒÉng s·ªëng
        - **TRISS = ISS + RTS + Age** ‚Üí ti√™n l∆∞·ª£ng ch√≠nh x√°c nh·∫•t
        - ISS ‚â•16 = "Major Trauma" ‚Üí c·∫ßn trauma center
        - ISS ‚â•25 = "Severe Trauma" ‚Üí t·ª≠ vong cao
        """)
        
        if result['risk_class'] in ['CRITICAL', 'UNSURVIVABLE', 'SEVERE']:
            st.error("""
            **üö® CH·∫§N TH∆Ø∆†NG N·∫∂NG/NGUY K·ªäCH:**
            
            - B·ªánh nh√¢n c√≥ nguy c∆° t·ª≠ vong CAO
            - C·∫ßn chuy·ªÉn Trauma Center Level I NGAY
            - Activate Trauma Team
            - Chu·∫©n b·ªã ph·∫´u thu·∫≠t c·∫•p c·ª©u
            - ICU care v√† h·ªó tr·ª£ to√†n di·ªán
            - Damage control resuscitation/surgery
            """)
        
        # Save to session state
        st.session_state['iss_result'] = result
        
        # Warning
        st.warning("""
        ‚ö†Ô∏è **L∆∞u √ù Y Khoa:**
        - ISS ƒë√≤i h·ªèi ki·∫øn th·ª©c v·ªÅ AIS - c·∫ßn ƒë√†o t·∫°o ƒë·ªÉ ƒë√°nh gi√° ch√≠nh x√°c
        - ISS l√† c√¥ng c·ª• h·ªó tr·ª£, kh√¥ng thay th·∫ø ƒë√°nh gi√° l√¢m s√†ng
        - K·∫øt h·ª£p ISS v·ªõi RTS ƒë·ªÉ c√≥ TRISS score (ti√™n l∆∞·ª£ng t·ªët h∆°n)
        - Quy·∫øt ƒë·ªãnh ƒëi·ªÅu tr·ªã cu·ªëi c√πng thu·ªôc v·ªÅ b√°c sƒ© ƒëi·ªÅu tr·ªã
        """)
    
    # AIS quick reference
    with st.expander("üìñ B·∫£ng Tham Kh·∫£o Nhanh - V√≠ D·ª• AIS"):
        st.markdown("""
        ### V√≠ D·ª• AIS Theo T·ª´ng V√πng
        
        #### 1. Head/Neck
        - **AIS 1:** Headache, kh√¥ng m·∫•t √Ω th·ª©c
        - **AIS 2:** Ch·∫•n ƒë·ªông n√£o (concussion) < 1h
        - **AIS 3:** Xu·∫•t huy·∫øt n·ªôi s·ªç nh·ªè, GCS 12-13
        - **AIS 4:** Xu·∫•t huy·∫øt n·ªôi s·ªç l·ªõn, GCS 8-11
        - **AIS 5:** Xu·∫•t huy·∫øt n·ªôi s·ªç l·ªõn + midline shift, GCS 3-7
        - **AIS 6:** T·ªïn th∆∞∆°ng th√¢n n√£o kh√¥ng th·ªÉ s·ªëng
        
        #### 2. Face
        - **AIS 1:** V·∫øt tr·∫ßy, b·∫ßm t√≠m m·∫∑t
        - **AIS 2:** G√£y x∆∞∆°ng m≈©i, h√†m ƒë∆°n gi·∫£n
        - **AIS 3:** G√£y x∆∞∆°ng h√†m ph·ª©c t·∫°p
        - **AIS 4:** G√£y x∆∞∆°ng m·∫∑t n·∫∑ng + t·ªïn th∆∞∆°ng m·∫Øt
        
        #### 3. Chest
        - **AIS 1:** B·∫ßm t√≠m th√†nh ng·ª±c
        - **AIS 2:** 1-2 x∆∞∆°ng s∆∞·ªùn g√£y
        - **AIS 3:** Hemothorax/Pneumothorax ƒë∆°n ƒë·ªôc, ‚â•3 x∆∞∆°ng s∆∞·ªùn g√£y
        - **AIS 4:** Flail chest, hemopneumothorax l·ªõn
        - **AIS 5:** R√°ch tim, ƒë·ª©t ƒë·ªông m·∫°ch ch·ªß l·ªõn
        - **AIS 6:** T·ªïn th∆∞∆°ng ƒë·ªông m·∫°ch ch·ªß kh√¥ng th·ªÉ s·ª≠a
        
        #### 4. Abdomen/Pelvis
        - **AIS 1:** B·∫ßm t√≠m th√†nh b·ª•ng
        - **AIS 2:** R√°ch l√°ch/gan ƒë·ªô I-II (minor)
        - **AIS 3:** R√°ch l√°ch/gan ƒë·ªô III, r√°ch th·∫≠n, g√£y x∆∞∆°ng ch·∫≠u ·ªïn ƒë·ªãnh
        - **AIS 4:** R√°ch gan ƒë·ªô IV, r√°ch th·∫≠n n·∫∑ng, g√£y x∆∞∆°ng ch·∫≠u kh√¥ng ·ªïn ƒë·ªãnh
        - **AIS 5:** R√°ch gan/l√°ch ƒë·ªô V, r√°ch ru·ªôt l·ªõn, ch·∫£y m√°u sau ph√∫c m·∫°c n·∫∑ng
        - **AIS 6:** ƒê·ª©t ƒë·ªông m·∫°ch ch·ªß b·ª•ng l·ªõn
        
        #### 5. Extremities/Pelvic Girdle
        - **AIS 1:** B·∫ßm t√≠m, bong g√¢n nh·∫π
        - **AIS 2:** G√£y x∆∞∆°ng ƒë∆°n gi·∫£n (quay, tr·ª•, m√°c, ch√†y)
        - **AIS 3:** G√£y x∆∞∆°ng ƒë√πi, g√£y 2 x∆∞∆°ng c·∫≥ng ch√¢n
        - **AIS 4:** G√£y x∆∞∆°ng ƒë√πi + m·∫°ch m√°u, ƒë·ª©t g·∫ßn ho√†n to√†n
        - **AIS 5:** ƒê·ª©t ho√†n to√†n chi + m·∫°ch m√°u l·ªõn
        
        #### 6. External
        - **AIS 1:** Tr·∫ßy da nh·ªè, b·ªèng ƒë·ªô I <10% TBSA
        - **AIS 2:** V·∫øt th∆∞∆°ng da, b·ªèng ƒë·ªô II 10-20% TBSA
        - **AIS 3:** B·ªèng ƒë·ªô II 20-30% TBSA ho·∫∑c ƒë·ªô III 10-20%
        - **AIS 4:** B·ªèng ƒë·ªô II 30-50% TBSA ho·∫∑c ƒë·ªô III 20-30%
        - **AIS 5:** B·ªèng ƒë·ªô II >50% TBSA ho·∫∑c ƒë·ªô III >30%
        
        **L∆∞u √Ω:** ƒê√¢y l√† v√≠ d·ª• ƒë∆°n gi·∫£n h√≥a. AIS dictionary ƒë·∫ßy ƒë·ªß c√≥ h√†ng ngh√¨n m√£ t·ªïn th∆∞∆°ng.
        """)

